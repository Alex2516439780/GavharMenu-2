if("undefined"!=typeof window){let e=null;let t=null;let o=[];let n=[];let a=null;let i={page:1,pageSize:24};!function(){try{const e=/localhost|127\.0\.0\.1/.test(location.hostname);const t=new URLSearchParams(location.search).has("debug");if(!e&&!t)["log","info","debug"].forEach(e=>{try{console[e]=function(){}}catch(e){}});console.log("Admin script loaded")}catch(e){}}();const s="/api";async function login(e,t){try{const o=await fetch(`${s}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});const n=await o.json();if(n.success){a=n.data.token;localStorage.setItem("admin_token",a);return true}else throw new Error(n.error||"–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞")}catch(e){console.error("Login error:",e);throw e}}function logout(){a=null;localStorage.removeItem("admin_token");showLoginModal()}function isAuthenticated(){return null!==a}async function apiRequest(e,t={}){let o=`${s}${e}`;const n={headers:{"Content-Type":"application/json",...t.headers},cache:"no-store",...t};const i=undefined;if("GET"===(n.method||"GET").toUpperCase()&&!/([?&])_t=/.test(o))o+=(o.includes("?")?"&":"?")+`_t=${Date.now()}`;if(a)n.headers.Authorization=`Bearer ${a}`;const r=await fetch(o,n);let c={};try{c=await r.json()}catch(e){}if(401===r.status||403===r.status){a=null;localStorage.removeItem("admin_token");if("function"==typeof showLoginModal)showLoginModal();throw new Error(c&&c.error||"–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")}if(!r.ok){const e=new Error(c&&c.error||`HTTP error! status: ${r.status}`);e.status=r.status;e.response=c;throw e}return c}async function loadDishes(){try{const e=document.getElementById("categorySelect")?.value||"";let t="/dishes?restaurant=true";if(e)t+=`&category=${encodeURIComponent(e)}`;t+=(t.includes("?")?"&":"?")+"light=1";const n=i.pageSize;const a=(i.page-1)*i.pageSize;t+=`&limit=${n}&offset=${a}`;const s=await apiRequest(t);o=s.data||[];if(0===a&&0===o.length&&s.total>0)i.page=1;if("number"==typeof s.total){i.total=s.total;i.pageSize=s.limit||n}else i.total=o.length;renderDishes()}catch(e){console.error("Error loading dishes:",e);showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥: "+e.message)}}async function loadCategories(){try{const e=await apiRequest("/categories?restaurant=true");n=e.data||[];renderCategories();updateCategorySelects()}catch(e){console.error("Error loading categories:",e);showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: "+e.message)}}async function loadSettings(){}function ensureDishesPaginationContainer(){let e=document.getElementById("dishesPagination");if(!e){const t=document.getElementById("dishesList");if(!t||!t.parentElement)return null;e=document.createElement("div");e.id="dishesPagination";e.className="dishes-pagination";t.parentElement.insertBefore(e,t.nextSibling)}return e}function renderDishesPagination(e){const t=ensureDishesPaginationContainer();if(!t)return;const o=Math.max(1,Math.ceil((i.total||e)/i.pageSize));const n=Math.min(i.page,o);i.page=n;const a=7;let s=Math.max(1,n-Math.floor(3.5));let r=Math.min(o,s+7-1);s=Math.max(1,Math.min(s,r-7+1));let c='<div class="pager">';c+=`<button class="pager-btn" data-page="prev" ${1===n?"disabled":""}>‚Äπ</button>`;for(let e=s;e<=r;e++)c+=`<button class="pager-btn ${e===n?"active":""}" data-page="${e}">${e}</button>`;c+=`<button class="pager-btn" data-page="next" ${n===o?"disabled":""}>‚Ä∫</button>`;c+="</div>";t.innerHTML=c}function renderDishes(){const e=document.getElementById("dishesList");if(!e)return;e.innerHTML="";const t=o.length;const n=Math.max(1,Math.ceil(t/i.pageSize));if(i.page>n)i.page=n;const a=(i.page-1)*i.pageSize;const s=Math.min(t,a+i.pageSize);const r=o.slice(a,s);const c=document.createDocumentFragment();const l=40;const d=r.length;let u=0;const g=window.requestIdleCallback||function(e){return setTimeout(e,16)};function m(o){let n=0;while(u<d&&n<l&&(!o||o.timeRemaining()>5)){const e=r[u++];const t=document.createElement("div");t.className="dish-item";const o=e.name&&e.name.ru?e.name.ru:"";const a=e.image||"/ELEMENTS/image 2.png";t.innerHTML=`\n                <div class="dish-item-header">\n                    <div style="display: flex; align-items: center; gap: 15px;">\n                        <img loading="lazy" decoding="async" src="${a}" width="80" height="80" alt="${o}" class="dish-item-image" />\n                        <div class="dish-item-info">\n                            <div class="dish-item-name">${o}</div>\n                            <div class="dish-item-category">${e.categoryName&&e.categoryName.ru?e.categoryName.ru:e.category||""}</div>\n                            <div class="dish-item-price">${null!=e.price?Number(e.price).toLocaleString():""} —Å—É–º</div>\n                            <div class="dish-status ${e.inStock?"in-stock":"out-of-stock"}" style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 8px;">\n                                ${e.inStock?"–í –Ω–∞–ª–∏—á–∏–∏":"–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"}\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div class="dish-item-actions">\n                    <button class="action-btn edit-btn" data-action="edit" data-id="${e.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>\n                    <button class="action-btn delete-btn" data-action="delete" data-id="${e.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>\n                    <button class="action-btn status-btn ${e.inStock?"":"inactive"}" data-action="toggle" data-id="${e.id}">\n                        ${e.inStock?"üëÅÔ∏è –°–∫—Ä—ã—Ç—å":"üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å"}\n                    </button>\n                </div>`;c.appendChild(t);n++}if(u<d)g(m);else{e.appendChild(c);renderDishesPagination(t)}}g(m)}function renderCategories(){const e=document.getElementById("categoriesList");if(!e)return;e.innerHTML="";const t=document.createDocumentFragment();for(let e=0;e<n.length;e++){const o=n[e];const a=document.createElement("div");a.className="category-item";const i=o.name&&o.name.ru?o.name.ru:"";const s=Array.isArray(o.subcategories)?o.subcategories.length:0;a.innerHTML=`\n            <div class="category-info">\n                <h3>${i}</h3>\n                <p class="category-key">–ö–ª—é—á: ${o.key}</p>\n                <p class="category-subcategories">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${s}</p>\n                <p class="category-alcohol ${o.isAlcoholic?"alcoholic":"non-alcoholic"}">\n                    ${o.isAlcoholic?"–ê–ª–∫–æ–≥–æ–ª—å–Ω–∞—è":"–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω–∞—è"}\n                </p>\n            </div>\n            <div class="category-actions">\n                <button class="action-btn edit-btn" data-action="edit-category" data-id="${o.id}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>\n                <button class="action-btn delete-btn" data-action="delete-category" data-id="${o.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>\n            </div>`;t.appendChild(a)}e.appendChild(t)}function updateCategorySelects(){const e=undefined;document.querySelectorAll("#dishCategory, #categorySelect").forEach(e=>{const t=e.value;if("categorySelect"===e.id)e.innerHTML='<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';else e.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';n.forEach(t=>{const o=document.createElement("option");o.value=t.key;o.textContent=t.name.ru;e.appendChild(o)});if([...e.options].some(e=>e.value===t))e.value=t})}async function saveDish(e){try{const t=await apiRequest("/dishes",{method:"POST",body:JSON.stringify(e)});if(t.success){showSuccess("–ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ");loadDishes();closeDishModal()}else throw new Error(t.error||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–ª—é–¥–∞")}catch(e){console.error("Error saving dish:",e);showError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª—é–¥–∞: "+e.message)}}async function updateDish(e,t){try{const o=await apiRequest(`/dishes/${e}`,{method:"PUT",body:JSON.stringify(t)});if(o.success){showSuccess("–ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ");loadDishes();closeDishModal()}else throw new Error(o.error||"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞")}catch(e){console.error("Error updating dish:",e);showError("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞: "+e.message)}}async function deleteDish(e){if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±–ª—é–¥–æ?"))return;try{const t=await apiRequest(`/dishes/${e}`,{method:"DELETE"});if(t.success){showSuccess("–ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ");loadDishes()}else throw new Error(t.error||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª—é–¥–∞")}catch(e){console.error("Error deleting dish:",e);showError("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª—é–¥–∞: "+e.message)}}async function toggleDishStatus(e,t){let n=false;const a=t||document.querySelector(`.status-btn[data-id="${e}"]`);const i=a?a.closest(".dish-item"):null;const s=i?i.querySelector(".dish-status"):null;const r=a?a.classList.contains("inactive"):false;const c=r;if(a&&s){a.classList.toggle("inactive",!c);a.textContent=c?"üëÅÔ∏è –°–∫—Ä—ã—Ç—å":"üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å";s.classList.toggle("in-stock",c);s.classList.toggle("out-of-stock",!c);s.textContent=c?"–í –Ω–∞–ª–∏—á–∏–∏":"–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"}try{const t=await apiRequest(`/dishes/${e}/toggle-status`,{method:"PATCH"});if(t.success){const n=o.findIndex(t=>t.id===e);if(-1!==n)o[n].inStock=!!t.data.inStock;showSuccess("–ë–ª—é–¥–æ "+(t.data.inStock?"–ø–æ–∫–∞–∑–∞–Ω–æ":"—Å–∫—Ä—ã—Ç–æ"));localStorage.setItem("gavhar_data_updated",Date.now().toString())}else throw new Error(t.error||"–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞")}catch(t){n=true;if(a&&s){a.classList.toggle("inactive",r);a.textContent=r?"üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å":"üëÅÔ∏è –°–∫—Ä—ã—Ç—å";s.classList.toggle("in-stock",!r);s.classList.toggle("out-of-stock",r);s.textContent=!r?"–í –Ω–∞–ª–∏—á–∏–∏":"–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"}console.error("Error toggling dish status:",t);console.error("Error details:",{message:t.message,stack:t.stack,dishId:e,wasInactive:r});let o="–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞";if(t.message)o+=": "+t.message;else if(t.status)o+=` (HTTP ${t.status})`;else o+=": –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";showError(o)}}async function saveCategory(e){try{const t=await apiRequest("/categories",{method:"POST",body:JSON.stringify(e)});if(t.success){showSuccess("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞");loadCategories();closeCategoryModal()}else throw new Error(t.error||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}catch(e){console.error("Error saving category:",e);showError("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: "+e.message)}}async function updateCategory(e,t){try{const o=await apiRequest(`/categories/${e}`,{method:"PUT",body:JSON.stringify(t)});if(o.success){showSuccess("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞");loadCategories();closeCategoryModal()}else throw new Error(o.error||"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}catch(e){console.error("Error updating category:",e);showError("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: "+e.message)}}async function deleteCategory(e){if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é?"))return;try{const t=await apiRequest(`/categories/${e}`,{method:"DELETE"});if(t.success){showSuccess("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞");loadCategories()}else throw new Error(t.error||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}catch(e){console.error("Error deleting category:",e);showError("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: "+e.message)}}async function saveSettings(){}function showLoginModal(){document.getElementById("loginModal").style.display="flex";document.getElementById("adminContainer").style.display="none"}function hideLoginModal(){document.getElementById("loginModal").style.display="none";document.getElementById("adminContainer").style.display="block"}function showDishModal(t=null){console.log("üçΩÔ∏è showDishModal called with ID:",t);e=t;const o=document.getElementById("dishModal");const n=document.getElementById("modalTitle");console.log("Modal element found:",!!o);console.log("Title element found:",!!n);clearDishForm();if(t){n.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ";setTimeout(()=>{loadDishForEdit(t)},50)}else n.textContent="–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ";if(o){o.style.display="flex";o.classList.add("active");console.log("‚úÖ Modal should be visible now")}else console.error("‚ùå Modal element not found!")}function closeDishModal(){document.getElementById("dishModal").style.display="none";e=null;clearDishForm()}function showCategoryModal(e=null){console.log("üìÅ showCategoryModal called with ID:",e);t=e;const o=document.getElementById("categoryModal");const n=document.getElementById("categoryModalTitle");console.log("Category modal element found:",!!o);console.log("Category title element found:",!!n);if(e){n.textContent="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é";loadCategoryForEdit(e)}else{n.textContent="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é";clearCategoryForm()}if(o){o.style.display="flex";o.classList.add("active");console.log("‚úÖ Category modal should be visible now")}else console.error("‚ùå Category modal element not found!")}function closeCategoryModal(){document.getElementById("categoryModal").style.display="none";t=null}function clearDishForm(){document.getElementById("dishForm").reset();const e=document.getElementById("mainImagePreview");const t=document.getElementById("galleryPreview");if(e)e.innerHTML="";if(t)t.innerHTML="";window.currentMainImage=null;window.currentGalleryImages=[];const o=document.getElementById("dishImageFile");const n=document.getElementById("dishImagesFiles");if(o)o.value="";if(n)n.value="";console.log("Form cleared, images reset")}function clearCategoryForm(){document.getElementById("categoryForm").reset();document.getElementById("subcategoriesManager").innerHTML=""}function editDish(e){showDishModal(e)}function editCategory(e){showCategoryModal(e)}async function loadDishForEdit(e){try{const t=o.find(t=>t.id===e);if(!t)return;document.getElementById("dishNameRu").value=t.name.ru;document.getElementById("dishNameUz").value=t.name.uz;document.getElementById("dishNameEn").value=t.name.en;document.getElementById("dishCategory").value=t.category;document.getElementById("dishPrice").value=t.price;document.getElementById("dishOrder").value=void 0!==t.order?t.order:1;console.log("Set order to:",void 0!==t.order?t.order:1);document.getElementById("dishWeight").value=t.weight||"";document.getElementById("dishTime").value=t.cookingTime||"";document.getElementById("dishCompositionRu").value=t.composition.ru||"";document.getElementById("dishCompositionUz").value=t.composition.uz||"";document.getElementById("dishCompositionEn").value=t.composition.en||"";document.getElementById("dishInStock").checked=t.inStock;document.getElementById("dishIsAlcoholic").checked=t.isAlcoholic;updateSubcategorySelect(t.category);setTimeout(()=>{const e=document.getElementById("dishSubcategory");if(e&&t.subcategory){e.value=t.subcategory;console.log("Set subcategory to:",t.subcategory)}},100);if(t.image){const e={url:t.image,originalName:"Existing image",filename:t.image.split("/").pop()};window.currentMainImage=e;updateMainImagePreview(e)}if(t.images&&t.images.length>0){const e=t.images.map(e=>({url:e,originalName:"Existing image",filename:e.split("/").pop()}));window.currentGalleryImages=e;updateGalleryImagesPreview([])}}catch(e){console.error("Error loading dish for edit:",e);showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–ª—é–¥–∞")}}async function loadCategoryForEdit(e){try{const t=n.find(t=>t.id===e);if(!t)return;document.getElementById("categoryNameRu").value=t.name.ru;document.getElementById("categoryNameUz").value=t.name.uz;document.getElementById("categoryNameEn").value=t.name.en;document.getElementById("categoryKey").value=t.key;document.getElementById("categoryIsAlcoholic").checked=t.isAlcoholic;loadSubcategoriesForEdit(t.subcategories)}catch(e){console.error("Error loading category for edit:",e);showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}}function updateSubcategorySelect(e){const t=document.getElementById("dishSubcategory");t.innerHTML='<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';const o=n.find(t=>t.key===e);if(o&&o.subcategories)o.subcategories.forEach(e=>{const o=document.createElement("option");o.value=e.key;o.textContent=e.name.ru;t.appendChild(o)})}function loadSubcategoriesForEdit(e){const t=undefined;document.getElementById("subcategoriesManager").innerHTML="";e.forEach((e,t)=>{addSubcategoryRow(e,t)})}function addSubcategoryRow(e=null,t=0){const o=document.getElementById("subcategoriesManager");const n=document.createElement("div");n.className="subcategory-row";n.innerHTML=`\n        <input type="text" placeholder="–ö–ª—é—á –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏" value="${e?.key||""}" class="subcategory-key" />\n        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)" value="${e?.name?.ru||""}" class="subcategory-name-ru" />\n        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (UZ)" value="${e?.name?.uz||""}" class="subcategory-name-uz" />\n        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (EN)" value="${e?.name?.en||""}" class="subcategory-name-en" />\n        <button type="button" class="remove-subcategory-btn" data-action="remove-subcategory">√ó</button>\n    `;o.appendChild(n)}function removeSubcategoryRow(e){e.parentElement.remove()}document.addEventListener("DOMContentLoaded",function(){const n=localStorage.getItem("admin_token");if(n){a=n;hideLoginModal();loadData()}else showLoginModal();document.getElementById("loginForm").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("username").value;const o=document.getElementById("password").value;try{await login(t,o);hideLoginModal();loadData()}catch(e){showError("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: "+e.message)}});document.getElementById("logoutBtn").addEventListener("click",logout);document.getElementById("refreshMenuBtn").addEventListener("click",function(){localStorage.setItem("gavhar_data_updated",Date.now().toString());window.open("menu.html","_blank");showSuccess("–ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ! –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π.")});document.querySelectorAll(".nav-btn").forEach(e=>{e.addEventListener("click",function(){const e=undefined;showSection(this.dataset.section)})});const s=document.getElementById("categorySelect");if(s){const e=debounce(function(){loadDishes()},200);s.addEventListener("change",e)}document.getElementById("dishForm").addEventListener("submit",async function(t){t.preventDefault();console.log("=== –°–û–•–†–ê–ù–ï–ù–ò–ï –ë–õ–Æ–î–ê ===");console.log("–û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:",window.currentMainImage);console.log("–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:",window.currentGalleryImages);console.log("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –≥–∞–ª–µ—Ä–µ–µ:",window.currentGalleryImages?window.currentGalleryImages.length:0);const o={name:{ru:document.getElementById("dishNameRu").value,uz:document.getElementById("dishNameUz").value,en:document.getElementById("dishNameEn").value},category:document.getElementById("dishCategory").value,subcategory:document.getElementById("dishSubcategory").value,price:parseInt(document.getElementById("dishPrice").value),order:parseInt(document.getElementById("dishOrder").value)||1,weight:document.getElementById("dishWeight").value,cookingTime:document.getElementById("dishTime").value,composition:{ru:document.getElementById("dishCompositionRu").value,uz:document.getElementById("dishCompositionUz").value,en:document.getElementById("dishCompositionEn").value},inStock:document.getElementById("dishInStock").checked,isAlcoholic:document.getElementById("dishIsAlcoholic").checked,image:window.currentMainImage?window.currentMainImage.url:null,images:window.currentGalleryImages?window.currentGalleryImages.map(e=>e.url):[]};console.log("–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:");console.log("- –û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:",o.image);console.log("- –ì–∞–ª–µ—Ä–µ—è (images):",o.images);console.log("========================");if(e)await updateDish(e,o);else await saveDish(o)});document.getElementById("categoryForm").addEventListener("submit",async function(e){e.preventDefault();const o=[];document.querySelectorAll(".subcategory-row").forEach(e=>{const t=e.querySelector(".subcategory-key").value;const n=e.querySelector(".subcategory-name-ru").value;const a=e.querySelector(".subcategory-name-uz").value;const i=e.querySelector(".subcategory-name-en").value;if(t&&n&&a&&i)o.push({key:t,name:{ru:n,uz:a,en:i}})});const n={key:document.getElementById("categoryKey").value,name:{ru:document.getElementById("categoryNameRu").value,uz:document.getElementById("categoryNameUz").value,en:document.getElementById("categoryNameEn").value},isAlcoholic:document.getElementById("categoryIsAlcoholic").checked,subcategories:o};if(t)await updateCategory(t,n);else await saveCategory(n)});document.getElementById("closeDishModal").addEventListener("click",closeDishModal);document.getElementById("closeCategoryModal").addEventListener("click",closeCategoryModal);document.getElementById("cancelDishBtn").addEventListener("click",closeDishModal);document.getElementById("cancelCategoryBtn").addEventListener("click",closeCategoryModal);document.getElementById("addDishBtn").addEventListener("click",()=>showDishModal());document.getElementById("addCategoryBtn").addEventListener("click",()=>showCategoryModal());document.getElementById("addSubcategoryBtn").addEventListener("click",()=>addSubcategoryRow());document.getElementById("dishCategory").addEventListener("change",function(){updateSubcategorySelect(this.value)});const r=document.getElementById("dishImageFile");const c=document.getElementById("dishImagesFiles");if(r)r.addEventListener("change",handleMainImageUpload);if(c)c.addEventListener("change",handleGalleryImagesUpload);document.addEventListener("click",function(e){if(e.target.matches("[data-action]")){const t=e.target.dataset.action;const o=parseInt(e.target.dataset.id);const n=parseInt(e.target.dataset.index);console.log("üîò Button clicked:",{action:t,id:o,index:n,element:e.target.tagName,className:e.target.className});switch(t){case"edit":editDish(o);break;case"delete":deleteDish(o);break;case"toggle":toggleDishStatus(o,e.target);break;case"edit-category":editCategory(o);break;case"delete-category":deleteCategory(o);break;case"remove-subcategory":removeSubcategoryRow(e.target);break;case"remove-main-image":removeMainImage();break;case"remove-gallery-image":removeGalleryImage(n);break;case"close-notification":e.target.closest(".notification").remove();break}}if(e.target.matches("#dishesPagination [data-page]")){const t=e.target.getAttribute("data-page");const n=Math.max(1,Math.ceil(o.length/i.pageSize));if("prev"===t&&i.page>1){i.page-=1;renderDishes()}else if("next"===t&&i.page<n){i.page+=1;renderDishes()}else{const e=parseInt(t,10);if(!isNaN(e)&&e>=1&&e<=n&&e!==i.page){i.page=e;renderDishes()}}}})});async function uploadImage(e,t=false){try{const t=new FormData;t.append("image",e);const o=await fetch("/api/upload/single",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("admin_token")}`},body:t});const n=await o.json();if(n.success)return n.data;else throw new Error(n.error||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞")}catch(e){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:",e);showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: "+e.message);return null}}async function uploadImages(e){try{const t=new FormData;Array.from(e).forEach(e=>{t.append("images",e)});const o=await fetch("/api/upload/multiple",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("admin_token")}`},body:t});const n=await o.json();if(n.success)return n.data;else throw new Error(n.error||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤")}catch(e){console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:",e);showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: "+e.message);return[]}}async function handleMainImageUpload(e){const t=e.target.files[0];if(!t){console.log("No file selected");return}console.log("Main image file selected:",t);if(t.size>15728640){showError("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 15MB");return}if(!t.type.startsWith("image/")){showError("–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");return}try{showNotification("–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...","info");console.log("Starting upload...");const e=await uploadImage(t,true);console.log("Upload result:",e);if(e){updateMainImagePreview(e);showSuccess("–û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ")}else showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")}catch(e){console.error("Upload error:",e);showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: "+e.message)}}async function handleGalleryImagesUpload(e){const t=e.target.files;if(!t||0===t.length)return;for(let e of t){if(e.size>15728640){showError(`–§–∞–π–ª ${e.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 15MB`);return}if(!e.type.startsWith("image/")){showError(`–§–∞–π–ª ${e.name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`);return}}try{showNotification("–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏...","info");const e=await uploadImages(t);if(e.length>0){updateGalleryImagesPreview(e);showSuccess(`${e.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –≥–∞–ª–µ—Ä–µ—é`)}}catch(e){showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≥–∞–ª–µ—Ä–µ–∏")}}function updateMainImagePreview(e){const t=document.getElementById("mainImagePreview");if(!t){console.error("mainImagePreview container not found");return}console.log("Updating main image preview:",e);t.innerHTML=`\n        <div class="preview-item main-preview">\n            <img src="${e.url}" alt="–û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="width: 150px; height: 150px; object-fit: cover;">\n            <button type="button" class="remove-image-btn" data-action="remove-main-image">√ó</button>\n            <div class="preview-filename">${e.originalName}</div>\n        </div>\n    `;window.currentMainImage=e}function updateGalleryImagesPreview(e){const t=document.getElementById("galleryPreview");if(!t){console.error("galleryPreview container not found");return}if(!window.currentGalleryImages)window.currentGalleryImages=[];if(e&&e.length>0)window.currentGalleryImages.push(...e);console.log("Updating gallery preview:",window.currentGalleryImages);t.innerHTML=window.currentGalleryImages.map((e,t)=>`\n        <div class="preview-item">\n            <img src="${e.url}" alt="–ì–∞–ª–µ—Ä–µ—è ${t+1}" style="width: 100px; height: 100px; object-fit: cover;">\n            <button type="button" class="remove-image-btn" data-action="remove-gallery-image" data-index="${t}">√ó</button>\n            <div class="preview-filename">${e.originalName}</div>\n        </div>\n    `).join("")}function removeMainImage(){const e=document.getElementById("mainImagePreview");if(e)e.innerHTML="";window.currentMainImage=null;const t=document.getElementById("dishImageFile");if(t)t.value=""}function removeGalleryImage(e){if(window.currentGalleryImages&&window.currentGalleryImages[e]){window.currentGalleryImages.splice(e,1);updateGalleryImagesPreview([])}}function showSection(e){document.querySelectorAll(".admin-section").forEach(e=>{e.classList.remove("active")});document.getElementById(e+"Section").classList.add("active");document.querySelectorAll(".nav-btn").forEach(e=>{e.classList.remove("active")});document.querySelector(`[data-section="${e}"]`).classList.add("active")}async function loadData(){await Promise.all([loadDishes(),loadCategories()])}function showSuccess(e){showNotification(e,"success")}function showError(e){showNotification(e,"error")}function showNotification(e,t="info"){const o=document.querySelector(".notification");if(o)o.remove();const n=document.createElement("div");n.className=`notification notification-${t}`;n.innerHTML=`\n        <div class="notification-content">\n            <span class="notification-icon">${"success"===t?"‚úÖ":"error"===t?"‚ùå":"‚ÑπÔ∏è"}</span>\n            <span class="notification-message">${e}</span>\n            <button class="notification-close" data-action="close-notification">√ó</button>\n        </div>\n    `;n.style.cssText=`\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        z-index: 10000;\n        background: ${"success"===t?"#27ae60":"error"===t?"#e74c3c":"#3498db"};\n        color: white;\n        padding: 15px 20px;\n        border-radius: 10px;\n        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);\n        animation: slideIn 0.3s ease;\n        max-width: 400px;\n    `;document.body.appendChild(n);setTimeout(()=>{if(n.parentElement){n.style.animation="slideOut 0.3s ease";setTimeout(()=>n.remove(),300)}},5e3)}if("undefined"!=typeof document){const r=document.createElement("style");r.textContent="\n        @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n        @keyframes slideOut {\n            from { transform: translateX(0); opacity: 1; }\n            to { transform: translateX(100%); opacity: 0; }\n        }\n        .notification-content {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n        .notification-close {\n            background: none;\n            border: none;\n            color: white;\n            font-size: 18px;\n            cursor: pointer;\n            margin-left: auto;\n        }\n        #dishesPagination { display: flex; justify-content: center; margin: 16px 0; }\n        #dishesPagination .pager { display: flex; gap: 6px; }\n        #dishesPagination .pager-btn {\n            background: #2d5a47; color: #d4af37; border: 2px solid #d4af37;\n            padding: 6px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;\n        }\n        #dishesPagination .pager-btn.active { background: #d4af37; color: #1a3d2e; }\n        #dishesPagination .pager-btn[disabled] { opacity: .5; cursor: default; }\n    ";document.head.appendChild(r)}if("undefined"!=typeof window){window.editDish=function(e){console.log("Edit dish clicked:",e);showDishModal(e)};window.deleteDish=function(e){console.log("Delete dish clicked:",e);if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –±–ª—é–¥–æ?"))return;apiRequest(`/dishes/${e}`,{method:"DELETE"}).then(e=>{if(e.success){showSuccess("–ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ");loadDishes()}else throw new Error(e.error||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª—é–¥–∞")}).catch(e=>{console.error("Error deleting dish:",e);showError("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª—é–¥–∞: "+e.message)})};window.toggleDishStatus=function(e){console.log("Toggle dish status clicked:",e);const t=undefined;toggleDishStatus(e,document.querySelector(`.status-btn[data-id="${e}"]`))};window.editCategory=function(e){showCategoryModal(e)};window.deleteCategory=function(e){if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é?"))return;apiRequest(`/categories/${e}`,{method:"DELETE"}).then(e=>{if(e.success){showSuccess("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞");loadCategories()}else throw new Error(e.error||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")}).catch(e=>{console.error("Error deleting category:",e);showError("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: "+e.message)})};window.removeSubcategoryRow=function(e){e.parentElement.remove()}}console.log("Global functions defined:",{editDish:typeof window.editDish,deleteDish:typeof window.deleteDish,toggleDishStatus:typeof window.toggleDishStatus,editCategory:typeof window.editCategory,deleteCategory:typeof window.deleteCategory})}function debounce(e,t){let o;return function(){const n=this,a=arguments;clearTimeout(o);o=setTimeout(function(){e.apply(n,a)},t)}}